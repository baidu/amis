{
    "version": 3,
    "file": "DiffEditor.js",
    "sourceRoot": "",
    "sources": [
        "/src/renderers/Form/DiffEditor.tsx"
    ],
    "names": [],
    "mappings": "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",
    "sourcesContent": [
        "import React from 'react';\nimport {Renderer} from '../../factory';\nimport {FormItem, FormControlProps, FormBaseControl} from './Item';\nimport LazyComponent from '../../components/LazyComponent';\nimport {\n  isPureVariable,\n  resolveVariableAndFilter\n} from '../../utils/tpl-builtin';\nimport {SchemaTokenizeableString} from '../../Schema';\nimport {autobind} from '../../utils/helper';\nimport {bindRendererEvent} from '../../actions/Decorators';\n\nimport type {Position} from 'monaco-editor';\nimport type {ListenerAction} from '../../actions/Action';\n\n/**\n * Diff 编辑器\n * 文档：https://baidu.gitee.io/amis/docs/components/form/diff\n */\nexport interface DiffControlSchema extends FormBaseControl {\n  /**\n   * 指定为 Diff 编辑器\n   */\n  type: 'diff-editor';\n\n  /**\n   * 左侧面板的值， 支持取变量。\n   */\n  diffValue?: SchemaTokenizeableString;\n\n  /**\n   * 语言，参考 monaco-editor\n   */\n  language?: string;\n\n  /**\n   * 编辑器配置\n   */\n  options?: any;\n}\n\nexport type DiffEditorRendererEvent = 'blur' | 'focus';\n\nfunction loadComponent(): Promise<any> {\n  return import('../../components/Editor').then(item => item.default);\n}\n\nexport interface DiffEditorProps\n  extends FormControlProps,\n    Omit<\n      DiffControlSchema,\n      'type' | 'className' | 'descriptionClassName' | 'inputClassName'\n    > {}\n\nfunction normalizeValue(value: any, language?: string) {\n  if (value && typeof value !== 'string') {\n    value = JSON.stringify(value, null, 2);\n  }\n\n  if (language && language === 'json') {\n    try {\n      value = JSON.stringify(\n        typeof value === 'string' ? JSON.parse(value) : value,\n        null,\n        2\n      );\n    } catch (e) {}\n  }\n\n  return value;\n}\n\nexport class DiffEditor extends React.Component<DiffEditorProps, any> {\n  static defaultProps: Partial<DiffEditorProps> = {\n    language: 'javascript',\n    theme: 'vs',\n    options: {\n      automaticLayout: false,\n      selectOnLineNumbers: true,\n      scrollBeyondLastLine: false,\n      folding: true,\n      minimap: {\n        enabled: false\n      }\n    },\n    diffValue: ''\n  };\n\n  state = {\n    focused: false\n  };\n\n  editor: any;\n  monaco: any;\n  originalEditor: any;\n  modifiedEditor: any;\n  toDispose: Array<Function> = [];\n  divRef = React.createRef<HTMLDivElement>();\n\n  constructor(props: DiffEditorProps) {\n    super(props);\n\n    this.handleFocus = this.handleFocus.bind(this);\n    this.handleBlur = this.handleBlur.bind(this);\n    this.editorFactory = this.editorFactory.bind(this);\n    this.handleEditorMounted = this.handleEditorMounted.bind(this);\n    this.handleModifiedEditorChange =\n      this.handleModifiedEditorChange.bind(this);\n  }\n\n  componentWillUnmount() {\n    this.toDispose.forEach(fn => fn());\n  }\n\n  doAction(action: ListenerAction, args: any) {\n    const actionType = action?.actionType as string;\n    const {onChange, resetValue} = this.props;\n\n    if (actionType === 'clear') {\n      onChange('');\n    } else if (actionType === 'reset') {\n      onChange(resetValue ?? '');\n    } else if (actionType === 'focus') {\n      this.focus();\n    }\n  }\n\n  focus() {\n    this.editor.focus();\n    this.setState({focused: true});\n\n    // 最近一次光标位置\n    const position: Position | null = this.editor?.getPosition();\n    this.editor?.setPosition(position);\n  }\n\n  @bindRendererEvent<DiffEditorProps, DiffEditorRendererEvent>('focus')\n  handleFocus() {\n    this.setState({\n      focused: true\n    });\n  }\n\n  @bindRendererEvent<DiffEditorProps, DiffEditorRendererEvent>('blur')\n  handleBlur() {\n    this.setState({\n      focused: false\n    });\n  }\n\n  componentDidUpdate(prevProps: any) {\n    const {data, value, diffValue, language} = this.props;\n\n    if (\n      this.originalEditor &&\n      (diffValue !== prevProps.diffValue || data !== prevProps.data)\n    ) {\n      this.originalEditor.getModel().setValue(\n        isPureVariable(diffValue as string)\n          ? normalizeValue(\n              resolveVariableAndFilter(\n                diffValue || '',\n                data,\n                '| raw',\n                () => ''\n              ),\n              language\n            )\n          : normalizeValue(diffValue, language)\n      );\n    }\n\n    if (\n      this.modifiedEditor &&\n      value !== prevProps.value &&\n      !this.state.focused\n    ) {\n      this.modifiedEditor.getModel().setValue(normalizeValue(value, language));\n    }\n  }\n\n  editorFactory(containerElement: any, monaco: any, options: any) {\n    return monaco.editor.createDiffEditor(containerElement, options);\n  }\n\n  handleEditorMounted(editor: any, monaco: any) {\n    const {value, data, language, diffValue} = this.props;\n\n    this.monaco = monaco;\n    this.editor = editor;\n    this.modifiedEditor = editor.getModifiedEditor();\n    this.originalEditor = editor.getOriginalEditor();\n\n    this.toDispose.push(\n      this.modifiedEditor.onDidFocusEditorWidget(this.handleFocus).dispose\n    );\n    this.toDispose.push(\n      this.modifiedEditor.onDidBlurEditorWidget(this.handleBlur).dispose\n    );\n    this.toDispose.push(\n      this.modifiedEditor.onDidChangeModelContent(\n        this.handleModifiedEditorChange\n      ).dispose\n    );\n\n    this.toDispose.push(\n      this.modifiedEditor.onDidChangeModelDecorations(() => {\n        this.updateContainerSize(this.modifiedEditor, monaco); // typing\n        requestAnimationFrame(\n          this.updateContainerSize.bind(this, this.modifiedEditor, monaco)\n        ); // folding\n      }).dispose\n    );\n\n    this.editor.setModel({\n      original: this.monaco.editor.createModel(\n        isPureVariable(diffValue as string)\n          ? normalizeValue(\n              resolveVariableAndFilter(diffValue || '', data, '| raw'),\n              language\n            )\n          : normalizeValue(diffValue, language),\n        language\n      ),\n      modified: this.monaco.editor.createModel(\n        normalizeValue(value, language),\n        language\n      )\n    });\n  }\n\n  handleModifiedEditorChange() {\n    const {onChange} = this.props;\n    onChange && onChange(this.modifiedEditor.getModel().getValue());\n  }\n\n  prevHeight = 0;\n  @autobind\n  updateContainerSize(editor: any, monaco: any) {\n    if (!this.divRef.current) {\n      return;\n    }\n\n    const lineHeight = editor.getOption(monaco.editor.EditorOption.lineHeight);\n    const lineCount = editor.getModel()?.getLineCount() || 1;\n    const height = editor.getTopForLineNumber(lineCount + 1) + lineHeight;\n\n    if (this.prevHeight !== height) {\n      this.prevHeight = height;\n      this.divRef.current.style.height = `${height}px`;\n      editor.layout();\n    }\n  }\n\n  render() {\n    const {\n      className,\n      value,\n      onChange,\n      disabled,\n      size,\n      options,\n      language,\n      theme,\n      classnames: cx\n    } = this.props;\n\n    return (\n      <div\n        ref={this.divRef}\n        className={cx(\n          'EditorControl',\n          size ? `EditorControl--${size}` : '',\n          className,\n          {\n            'is-focused': this.state.focused\n          }\n        )}\n      >\n        <LazyComponent\n          getComponent={loadComponent}\n          value={value}\n          onChange={onChange}\n          disabled={disabled}\n          language={language}\n          theme={theme}\n          editorDidMount={this.handleEditorMounted}\n          editorFactory={this.editorFactory}\n          options={{\n            ...options,\n            readOnly: disabled\n          }}\n          isDiffEditor\n        />\n      </div>\n    );\n  }\n}\n\n@FormItem({\n  type: `diff-editor`,\n  sizeMutable: false\n})\nexport class DiffEditorControlRenderer extends DiffEditor {\n  static defaultProps = {\n    ...DiffEditor.defaultProps\n  };\n}\n\n// @Renderer({\n//   test: /(^|\\/)diff-editor$/,\n//   name: 'diff-editor'\n// })\n// export class DiffEditorRenderer extends DiffEditor {\n//   static defaultProps = {\n//     ...DiffEditor.defaultProps,\n//     disabled: true\n//   };\n// }\n"
    ]
}