{
    "version": 3,
    "file": "WithStore.js",
    "sourceRoot": "",
    "sources": [
        "/src/WithStore.tsx"
    ],
    "names": [],
    "mappings": "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",
    "sourcesContent": [
        "import hoistNonReactStatic from 'hoist-non-react-statics';\nimport {observer} from 'mobx-react';\nimport {isAlive} from 'mobx-state-tree';\nimport React from 'react';\nimport {RendererProps} from './factory';\nimport {IIRendererStore, IRendererStore} from './store';\nimport {RendererData, SchemaNode} from './types';\nimport getExprProperties from './utils/filter-schema';\nimport {\n  createObject,\n  extendObject,\n  guid,\n  isObjectShallowModified,\n  syncDataFromSuper,\n  isSuperDataModified\n} from './utils/helper';\nimport {dataMapping} from './utils/tpl-builtin';\nimport {RootStoreContext} from './WithRootStore';\n\nexport function HocStoreFactory(renderer: {\n  storeType: string;\n  extendsData?: boolean | ((props: any) => boolean);\n  shouldSyncSuperStore?: (\n    store: any,\n    props: any,\n    prevProps: any\n  ) => boolean | undefined;\n}): any {\n  return function <T extends React.ComponentType<RendererProps>>(Component: T) {\n    type Props = Omit<\n      RendererProps,\n      'store' | 'data' | 'dataUpdatedAt' | 'scope'\n    > & {\n      store?: IIRendererStore;\n      data?: RendererData;\n      scope?: RendererData;\n    };\n\n    @observer\n    class StoreFactory extends React.Component<Props> {\n      static displayName = `WithStore(${\n        Component.displayName || Component.name\n      })`;\n      static ComposedComponent = Component;\n      static contextType = RootStoreContext;\n      store: IIRendererStore;\n      context!: React.ContextType<typeof RootStoreContext>;\n      ref: any;\n\n      constructor(\n        props: Props,\n        context: React.ContextType<typeof RootStoreContext>\n      ) {\n        super(props);\n\n        const rootStore = context;\n        this.renderChild = this.renderChild.bind(this);\n        this.refFn = this.refFn.bind(this);\n\n        const store = rootStore.addStore({\n          id: guid(),\n          path: this.props.$path,\n          storeType: renderer.storeType,\n          parentId: this.props.store ? this.props.store.id : ''\n        }) as IIRendererStore;\n        this.store = store;\n\n        const extendsData =\n          typeof renderer.extendsData === 'function'\n            ? renderer.extendsData(props)\n            : renderer.extendsData;\n\n        if (extendsData === false) {\n          store.initData(\n            createObject(\n              (this.props.data as any)\n                ? (this.props.data as any).__super\n                : null,\n              {\n                ...this.formatData(\n                  dataMapping(this.props.defaultData, this.props.data)\n                ),\n                ...this.formatData(this.props.data)\n              }\n            )\n          );\n        } else if (\n          this.props.scope ||\n          (this.props.data && (this.props.data as any).__super)\n        ) {\n          if (this.props.store && this.props.data === this.props.store.data) {\n            store.initData(\n              createObject(this.props.store.data, {\n                ...this.formatData(\n                  dataMapping(this.props.defaultData, this.props.data)\n                )\n              })\n            );\n          } else {\n            store.initData(\n              createObject(\n                (this.props.data as any).__super || this.props.scope,\n                {\n                  ...this.formatData(\n                    dataMapping(this.props.defaultData, this.props.data)\n                  ),\n                  ...this.formatData(this.props.data)\n                }\n              )\n            );\n          }\n        } else {\n          store.initData({\n            ...this.formatData(\n              dataMapping(this.props.defaultData, this.props.data)\n            ),\n            ...this.formatData(this.props.data)\n          });\n        }\n      }\n\n      getWrappedInstance() {\n        return this.ref;\n      }\n\n      refFn(ref: any) {\n        this.ref = ref;\n      }\n\n      formatData(data: any): object {\n        if (Array.isArray(data)) {\n          return {\n            items: data\n          };\n        }\n\n        return data as object;\n      }\n\n      componentDidUpdate(prevProps: RendererProps) {\n        const props = this.props;\n        const store = this.store;\n        const shouldSync = renderer.shouldSyncSuperStore?.(\n          store,\n          props,\n          prevProps\n        );\n\n        if (shouldSync === false) {\n          return;\n        }\n\n        const extendsData =\n          typeof renderer.extendsData === 'function'\n            ? renderer.extendsData(props)\n            : renderer.extendsData;\n        if (extendsData === false) {\n          if (\n            shouldSync === true ||\n            prevProps.defaultData !== props.defaultData ||\n            isObjectShallowModified(prevProps.data, props.data) ||\n            //\n            // 特殊处理 CRUD。\n            // CRUD 中 toolbar 里面的 data 是空对象，但是 __super 会不一样\n            (props.data &&\n              prevProps.data &&\n              props.data.__super !== prevProps.data.__super)\n          ) {\n            store.initData(\n              extendObject(props.data, {\n                ...(store.hasRemoteData ? store.data : null), // todo 只保留 remote 数据\n                ...this.formatData(props.defaultData),\n                ...this.formatData(props.data)\n              })\n            );\n          }\n        } else if (\n          shouldSync === true ||\n          isObjectShallowModified(prevProps.data, props.data) ||\n          (props.syncSuperStore !== false &&\n            isSuperDataModified(props.data, prevProps.data, store))\n        ) {\n          if (props.store && props.store.data === props.data) {\n            store.initData(\n              createObject(\n                props.store.data,\n                props.syncSuperStore === false\n                  ? {\n                      ...store.data\n                    }\n                  : syncDataFromSuper(\n                      store.data,\n                      props.store.data,\n                      prevProps.scope,\n                      store,\n                      props.syncSuperStore === true\n                    )\n              )\n            );\n          } else if (props.data && (props.data as any).__super) {\n            store.initData(\n              extendObject(\n                props.data,\n                store.hasRemoteData || store.path === 'page'\n                  ? {\n                      ...store.data,\n                      ...props.data\n                    }\n                  : undefined\n              )\n            );\n          } else {\n            store.initData(createObject(props.scope, props.data));\n          }\n        } else if (\n          (shouldSync === true ||\n            !props.store ||\n            props.data !== props.store.data) &&\n          props.data &&\n          props.data.__super\n        ) {\n          // 这个用法很少，当 data.__super 值发生变化时，更新 store.data\n          if (\n            !prevProps.data ||\n            isObjectShallowModified(\n              props.data.__super,\n              prevProps.data.__super,\n              false\n            )\n          ) {\n            store.initData(\n              createObject(props.data.__super, {\n                ...props.data,\n                ...store.data\n              }),\n\n              store.storeType === 'FormStore' &&\n                prevProps.store?.storeType === 'CRUDStore'\n            );\n          }\n          // nextProps.data.__super !== props.data.__super) &&\n        } else if (\n          props.scope &&\n          props.data === props.store!.data &&\n          (shouldSync === true || prevProps.data !== props.data)\n        ) {\n          // 只有父级数据变动的时候才应该进来，\n          // 目前看来这个 case 很少有情况下能进来\n          store.initData(\n            createObject(props.scope, {\n              // ...nextProps.data,\n              ...store.data\n            })\n          );\n        }\n      }\n\n      componentWillUnmount() {\n        const rootStore = this.context as IRendererStore;\n        const store = this.store;\n\n        isAlive(store) && rootStore.removeStore(store);\n\n        // @ts-ignore\n        delete this.store;\n      }\n\n      renderChild(\n        region: string,\n        node: SchemaNode,\n        subProps: {\n          data?: object;\n          [propName: string]: any;\n        } = {}\n      ) {\n        let {render} = this.props;\n\n        return render(region, node, {\n          data: this.store.data,\n          dataUpdatedAt: this.store.updatedAt,\n          ...subProps,\n          scope: this.store.data,\n          store: this.store\n        });\n      }\n\n      render() {\n        const {detectField, ...rest} = this.props;\n\n        let exprProps: any = {};\n        if (!detectField || detectField === 'data') {\n          exprProps = getExprProperties(rest, this.store.data, undefined, rest);\n\n          if (exprProps.hidden || exprProps.visible === false) {\n            return null;\n          }\n        }\n\n        return (\n          <Component\n            {\n              ...(rest as any) /* todo */\n            }\n            {...exprProps}\n            ref={this.refFn}\n            data={this.store.data}\n            dataUpdatedAt={this.store.updatedAt}\n            store={this.store}\n            scope={this.store.data}\n            render={this.renderChild}\n          />\n        );\n      }\n    }\n    hoistNonReactStatic(StoreFactory, Component);\n\n    return StoreFactory;\n  };\n}\n"
    ]
}